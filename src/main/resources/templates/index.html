<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">

<head th:replace="fragments/header.html :: head">
    <meta name="_csrf" content="${_csrf.token}"/>
</head>

<body class="bg-light">
<nav th:replace="fragments/navbar.html :: auth-nav"></nav>
<div class="alert alert-warning" role="alert" th:if="${member != null && member.emailVerified == false}">
    TechDot 가입을 완료하려면 <a href="#" th:href="@{/check-email}" class="alert-link"> 계정 인증 이메일을 확인 </a>하세요.
</div>
<div class="container">
<div class="row  py-3">
    <nav th:replace="fragments/main-view-menu.html :: main-menu(mainMenu='all')"></nav>
</div>
<div class="row justify-content-center py-1">
    <div class="col-sm-11 py-2">
        <div class="row post-list" id="post-list">
        </div>
        <!-- Pagination List -->
        <ul class="post-list__pagination post-list__pagination--inactive" id="post-list-pagination" style="display: none"></ul>
    </div>
</div>

<footer th:replace="fragments/footer.html :: footer"></footer>
<script type="application/javascript" th:inline="javascript" th:fragment="ajax-csrf-header">
    $(function() {
        var csrfToken = /*[[${_csrf.token}]]*/ null;
        var csrfHeader = /*[[${_csrf.headerName}]]*/ null;
        $(document).ajaxSend(function (e, xhr, options) {
            xhr.setRequestHeader(csrfHeader, csrfToken);
        });
    });
</script>

<script type="text/javascript" th:inline="javascript">
    /*<![CDATA[*/
    function getPageId(n) {
        return 'page-' + n;
    }

    function getDocumentHeight() {
        const body = document.body;
        const html = document.documentElement;
        return Math.max(body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight);
    }

    function getScrollTop() {
        return window.pageYOffset !== undefined ? window.pageYOffset : (document.documentElement || document.body.parentNode || document.body).scrollTop;
    }

    function getPostImage(data) {
        const image = new Image();
        image.className = 'post-list__item__image post-list__item__image--loading';
        if(data.thumbnailImage == null || data.thumbnailImage == ''){
            image.src = '/images/default_thumbnail.png'
        }else{
            image.src = data.thumbnailImage;
        }
        image.onload = function () {
            image.classList.remove('post-list__item__image--loading');
        };
        return image;
    }

    function getCardContent(data){
        const body = document.createElement('div');
        body.className ='card-body';
        body.style = 'overflow: hidden; height: 210px';

        const category = document.createElement('small');
        category.textContent = data.categoryName;
        body.appendChild(category)

        const link1 = document.createElement('a');
        link1.href= data.link;
        link1.className='text-dark';
        body.appendChild(link1);

        const link2 = document.createElement('a');
        link2.href= data.link;
        link2.className='text-dark';
        body.appendChild(link2);

        const title = document.createElement('h5');
        title.className='card-title context';
        title.textContent = data.title;
        link1.appendChild(title);

        const content = document.createElement('p');
        content.className = 'card-text';
        content.textContent = data.content;
        link2.appendChild(content);

        return body;
    }

    function getCardEnd(){
        const end = document.createElement('div');
        end.className ='card-body';

        const writerBody = document.createElement('div');
        writerBody.className='d-flex justify-content-between align-items-center';
        end.appendChild(writerBody);

        const small1 = document.createElement('small');
        small1.className='text-muted';
        writerBody.appendChild(small1);

        const icon = document.createElement('i');
        icon.className='fa fa-user-circle';
        small1.appendChild(icon);

        const writerText = document.createElement('span');
        writerText.textContent='loosie';
        small1.appendChild(writerText);

        const small2 = document.createElement('small');
        small2.className='text-muted';
        writerBody.appendChild(small2);

        const postType = document.createElement('span');
        postType.textContent='BLOG';
        small2.appendChild(postType);

        return end;
    }

    function getPost(data) {
        const articleImage = getPostImage(data);
        const article = document.createElement('div');
        article.className = 'post-list__item card mb shadow-sm';
        article.appendChild(articleImage);

        const cardContent = getCardContent(data);
        const cardEnd = getCardEnd(data);

        const link = document.createElement('a');
        link.href= data.link;
        link.className='text-dark';
        article.appendChild(link);

        link.appendChild(articleImage);
        article.appendChild(cardContent);
        article.appendChild(cardEnd);
        return article;
    }

    function getArticlePage(data) {
        const pageElement = document.createElement('div');
        pageElement.className = 'post-list__page col-md-3 py-3';
        pageElement.appendChild(getPost(data));
        return pageElement;
    }

    function addPaginationPage(page) {
        const pageLink = document.createElement('a');
        pageLink.href = '#' + getPageId(page);
        pageLink.innerHTML = page;
        const listItem = document.createElement('li');
        listItem.className = 'post-list__pagination__item';
        listItem.appendChild(pageLink);
        articleListPagination.appendChild(listItem);
        if (page === 2) {
            articleListPagination.classList.remove('post-list__pagination--inactive');
        }
    }

    const postsPerPageSize = 12;
    var flag = true;
    // ajax로 서버에 post 데이터 요청
    function addPage(page) {
        $.ajax({
            type: 'GET',
            url: '/post/scrollList',
            async: false,
            data: {
                page: page, // current page
                size: postsPerPageSize, //page size
            },
            dataType: 'json'
        }).done(function(result) {
            console.log(result);
            if (result.length == 0) {
                flag = false;
                return;
            }

            for(var i=0; i<result.length; i++){
                articleList.appendChild(getArticlePage(result[i]));
            }
            addPaginationPage(page);
        });
    }

    /* * Main */
    const articleList = document.getElementById('post-list');
    const articleListPagination = document.getElementById('post-list-pagination');
    let page = 0; // 초기 페이지 로드
    addPage(++page);
    window.onscroll = function () {
        if (!flag || (getScrollTop() < getDocumentHeight() - window.innerHeight - 10)) return; // 스크롤이 페이지 하단에 도달할 경우 새 페이지 로드
        addPage(++page);
    }; /*]]>*/
</script>

</body>
</html>