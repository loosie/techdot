<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.com">

<body th:fragment="main-view (mainMenu)" class="bg-light">
<nav th:replace="fragments/navbar.html :: auth-nav"></nav>

<div class="alert alert-warning" role="alert" th:if="${member != null && member.emailVerified == false}">
    TechDot 가입을 완료하려면 <a href="#" th:href="@{/check-email}" class="alert-link"> 계정 인증 이메일을 확인 </a>하세요.
</div>

<div class="container main-view-container" th:id="${mainMenu}">
    <div class="row justify-content-center py-1">
        <div class="col-2 py-4">
            <nav th:replace="fragments/main-view-category-menu.html :: category-menu(categoryMenu = ${mainMenu})"></nav>
        </div>

        <div class="col-sm-10">
            <div class="row post-list" id="post-list">
            </div>
            <!-- Pagination List -->
            <ul class="post-list__pagination post-list__pagination--inactive" id="post-list-pagination"
                style="display: none"></ul>
        </div>

    </div>
</div>

<footer th:replace="fragments/footer.html :: footer"></footer>

<script type="application/javascript" th:inline="javascript" th:fragment="ajax-csrf-header">
    $(function () {
        var csrfToken = /*[[${_csrf.token}]]*/ null;
        var csrfHeader = /*[[${_csrf.headerName}]]*/ null;
        $(document).ajaxSend(function (e, xhr, options) {
            xhr.setRequestHeader(csrfHeader, csrfToken);
        });
    });
</script>

<script type="text/javascript" th:inline="javascript">
    /*<![CDATA[*/
    function getPageId(n) {
        return 'page-' + n;
    }

    function getDocumentHeight() {
        const body = document.body;
        const html = document.documentElement;
        return Math.max(body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight);
    }

    function getScrollTop() {
        return window.pageYOffset !== undefined ? window.pageYOffset : (document.documentElement || document.body.parentNode || document.body).scrollTop;
    }

    function getPostImage(data) {
        const image = new Image();
        image.className = 'post-list__item__image post-list__item__image--loading';
        if (data.thumbnailImage == null || data.thumbnailImage == '') {
            image.src = '/images/default_thumbnail.png'
        } else {
            image.src = data.thumbnailImage;
        }
        image.onload = function () {
            image.classList.remove('post-list__item__image--loading');
        };
        return image;
    }

    function getCardContent(data) {
        const body = document.createElement('div');
        body.className = 'card-body';
        body.style = 'overflow: hidden; height: 210px';

        const category = document.createElement('span');
        category.className = 'badge badge-light';
        category.textContent = data.categoryName;
        body.appendChild(category)

        const link1 = document.createElement('a');
        link1.href = data.link;
        link1.className = 'text-dark';
        body.appendChild(link1);

        const link2 = document.createElement('a');
        link2.href = data.link;
        link2.className = 'text-dark';
        body.appendChild(link2);

        const title = document.createElement('h5');
        title.className = 'card-title context';
        title.textContent = data.title;
        link1.appendChild(title);

        const content = document.createElement('p');
        content.className = 'card-text';
        content.textContent = data.content;
        link2.appendChild(content);

        return body;
    }

    function getCardEnd(data) {
        const end = document.createElement('div');
        end.className = 'card-body';

        const writerBody = document.createElement('div');
        writerBody.className = 'd-flex justify-content-between align-items-center';
        end.appendChild(writerBody);

        const small1 = document.createElement('small');
        small1.className = 'text-muted';
        writerBody.appendChild(small1);

        const icon = document.createElement('i');
        icon.className = 'fa fa-user-circle';
        small1.appendChild(icon);

        const writerText = document.createElement('span');
        writerText.textContent = data.writer;
        small1.appendChild(writerText);

        const small2 = document.createElement('small');
        small2.className = 'text-muted';
        writerBody.appendChild(small2);

        const postType = document.createElement('span');
        postType.className= 'badge badge-pill'
        if(data.type === 'BLOG') {
            postType.className += ' badge-blog'
            postType.textContent = 'Blog';
        }
        if(data.type === 'VIDEO') {
            postType.className += ' badge-video'
            postType.textContent = 'Video';
        }
        small2.appendChild(postType);

        return end;
    }

    function getPost(data) {
        const postImage = getPostImage(data);
        const post = document.createElement('div');
        post.className = 'post-list__item card mb shadow-sm';
        post.appendChild(postImage);

        const cardContent = getCardContent(data);
        const cardEnd = getCardEnd(data);

        const link = document.createElement('a');
        link.href = data.link;
        link.className = 'text-dark';
        post.appendChild(link);

        link.appendChild(postImage);
        post.appendChild(cardContent);
        post.appendChild(cardEnd);
        return post;
    }

    function getPostPage(data) {
        const pageElement = document.createElement('div');
        pageElement.className = 'post-list__page col-md-3 py-3';
        pageElement.appendChild(getPost(data));
        return pageElement;
    }

    function addPaginationPage(page) {
        const pageLink = document.createElement('a');
        pageLink.href = '#' + getPageId(page);
        pageLink.innerHTML = page;
        const listItem = document.createElement('li');
        listItem.className = 'post-list__pagination__item';
        listItem.appendChild(pageLink);
        articleListPagination.appendChild(listItem);
        if (page === 2) {
            articleListPagination.classList.remove('post-list__pagination--inactive');
        }
    }

    const postsPerPageSize = 12;
    var flag = true;

    // ajax로 서버에 post 데이터 요청
    function addPage(page, viewName) {
        $.ajax({
            type: 'GET',
            url: '/posts/' + viewName,
            async: false,
            data: {
                page: page, // current page
                size: postsPerPageSize, //page size
                categoryName: viewName
            },
            dataType: 'json'
        }).done(function (result) {
            console.log(result);
            if (result.length == 0) {
                flag = false;
                return;
            }

            for (var i = 0; i < result.length; i++) {
                postList.appendChild(getPostPage(result[i]));
            }
            addPaginationPage(page);
        });
    }

    /* * Main */
    const postList = document.getElementById('post-list');
    const container = document.getElementsByClassName('main-view-container');
    const viewName = container[0].id;
    const articleListPagination = document.getElementById('post-list-pagination');
    let page = 0; // 초기 페이지 로드
    addPage(++page, viewName);
    window.onscroll = function () {
        if (!flag || (getScrollTop() < getDocumentHeight() - window.innerHeight - 100)) return; // 스크롤이 페이지 하단에 도달할 경우 새 페이지 로드
        addPage(++page, viewName);
    }; /*]]>*/
</script>

</body>
</html>